<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FeelWell ‚Äî All-in-One Modular</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f7fbff;
  --card: #ffffff;
  --muted: #6b7280;
  --primary: #6366f1;
}
* {
  box-sizing: border-box;
  font-family: Inter, system-ui, Arial, sans-serif;
}
body {
  margin: 0;
  background: var(--bg);
  color: #0f1724;
}
.wrap {
  max-width: 1100px;
  margin: 20px auto;
  padding: 18px;
}
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
h1 {
  margin: 0;
  font-size: 20px;
}
.panel {
  display: grid;
  grid-template-columns: 340px 1fr;
  gap: 18px;
  margin-top: 16px;
}
.card {
  background: var(--card);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 20px rgba(2, 6, 23, 0.06);
}
.small {
  font-size: 13px;
  color: var(--muted);
}
.avatar-list {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.avatar {
  width: 68px;
  height: 68px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 2px solid transparent;
  font-size: 28px;
}
.avatar.selected {
  outline: 3px solid rgba(99, 102, 241, 0.14);
  box-shadow: 0 6px 14px rgba(99, 102, 241, 0.06);
}
.color-row {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}
.color-swatch {
  width: 34px;
  height: 34px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
}
.color-swatch.selected {
  outline: 3px solid rgba(0, 0, 0, 0.06);
}
.emotions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.emotion {
  padding: 10px 12px;
  border-radius: 10px;
  background: #fafafa;
  cursor: pointer;
  display: flex;
  gap: 8px;
  align-items: center;
  border: 1px solid #eee;
}
.emotion.selected {
  background: linear-gradient(90deg, #eef2ff, #fff7ed);
  border-color: #e6e6ff;
}
.stage {
  min-height: 360px;
  border-radius: 12px;
  padding: 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
}
.character {
  width: 160px;
  height: 160px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 64px;
  transition: transform 0.4s ease;
}
.item {
  font-size: 44px;
  transition: transform 0.4s ease;
}
.actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}
button {
  padding: 10px 14px;
  border-radius: 10px;
  border: 0;
  cursor: pointer;
}
.btn-primary {
  background: var(--primary);
  color: #fff;
}
.btn-ghost {
  background: #f3f4f6;
}
.notice {
  margin-top: 12px;
  color: #374151;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px dashed #e6e6e6;
}
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}
.chart-wrap {
  height: 220px;
  padding: 8px;
}
.footer {
  margin-top: 18px;
  text-align: center;
  color: var(--muted);
  font-size: 13px;
}
.badge {
  display: inline-block;
  padding: 6px 8px;
  border-radius: 8px;
  background: #f1f5ff;
  color: #3730a3;
  font-weight: 600;
}
.task-input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #eee;
  margin-top: 8px;
}
@media (max-width: 980px) {
  .panel {
    grid-template-columns: 1fr;
  }
  .left {
    order: 2;
  }
}
/* --- Healthy AI Chatbox --- */
#healthyAIWidget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  font-size: 14px;
  z-index: 9999;
  font-family: Inter, system-ui, sans-serif;
}

#healthyAIHeader {
  background: var(--primary);
  color: white;
  padding: 10px;
  border-radius: 10px 10px 0 0;
  cursor: pointer;
  font-weight: bold;
}

#healthyAIBody {
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  display: none;
  flex-direction: column;
  height: 380px;
  border-radius: 0 0 10px 10px;
  overflow: hidden;
}

#healthyAIChat {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.healthyAIMessage {
  margin-bottom: 8px;
  line-height: 1.4;
}

.healthyAIMessage.user {
  text-align: right;
  color: #2563eb;
}

.healthyAIMessage.ai {
  text-align: left;
  color: #374151;
}

#healthyAIInputArea {
  display: flex;
  border-top: 1px solid #ddd;
}

#healthyAIInput {
  flex: 1;
  padding: 8px;
  border: none;
  outline: none;
}

#healthyAISend {
  background: var(--primary);
  color: white;
  border: none;
  padding: 0 14px;
  cursor: pointer;
}


:root{--bg:#f0f4ff;--card:#fff;--primary:#6366f1;--muted:#6b7280}
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{overflow-y:auto; margin:0;background:var(--bg);display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-wrap{width:420px;padding:12px}
.card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08)}
h1{text-align:center;color:var(--primary);margin:0 0 12px}
.tabs{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:8px;background:#f3f4f6;border:0;cursor:pointer}
.tab.active{background:var(--primary);color:#fff}
.form{display:flex;flex-direction:column;gap:8px}
.hidden{display:none}
input,select{padding:10px;border-radius:8px;border:1px solid #e6e6f0}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
.primary{background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
.link{background:transparent;border:0;color:var(--primary);cursor:pointer;text-decoration:underline;padding:8px}
.message{min-height:24px;color:#dc2626;font-size:14px}
.message.success{color:#16a34a}

</style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" style="display:none">

<div class="login-wrap">
  <div class="card">
    <h1>FeelWell</h1>
    <div class="tabs">
      <button id="showLogin" class="tab active">ƒêƒÉng nh·∫≠p</button>
      <button id="showRegister" class="tab">ƒêƒÉng k√Ω</button>
    </div>

    <div id="loginForm" class="form">
      <label>T√™n ng∆∞·ªùi d√πng</label>
      <input id="loginUsername" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p">
      <label>M·∫≠t kh·∫©u</label>
      <input id="loginPassword" type="password" placeholder="M·∫≠t kh·∫©u">
      <div class="row">
        <button id="loginBtn" class="primary">ƒêƒÉng nh·∫≠p</button>
        <button id="forgotBtn" class="link">Qu√™n m·∫≠t kh·∫©u?</button>
      </div>
      <div id="loginMessage" class="message"></div>
    </div>

    <div id="registerForm" class="form hidden">
      <label>Username</label>
      <input id="regUsername" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p">
      <label>Email</label>
      <input id="regEmail" type="email" placeholder="Email">
      <label>M·∫≠t kh·∫©u</label>
      <input id="regPassword" type="password" placeholder="M·∫≠t kh·∫©u">
      <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
      <input id="regConfirm" type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u">
      <label>C√¢u h·ªèi b·∫£o m·∫≠t</label>
      <select id="regQuestion">
        <option value="">-- Ch·ªçn c√¢u h·ªèi --</option>
        <option value="pet">T√™n th√∫ c∆∞ng ƒë·∫ßu ti√™n?</option>
        <option value="school">T√™n tr∆∞·ªùng ti·ªÉu h·ªçc?</option>
        <option value="city">T√™n th√†nh ph·ªë n∆°i b·∫°n sinh?</option>
      </select>
      <label>Tr·∫£ l·ªùi</label>
      <input id="regAnswer" type="text" placeholder="C√¢u tr·∫£ l·ªùi b·∫£o m·∫≠t">
      <div class="row">
        <button id="registerBtn" class="primary">ƒêƒÉng k√Ω</button>
        <button id="regToLogin" class="link">ƒê√£ c√≥ t√†i kho·∫£n?</button>
      </div>
      <div id="regMessage" class="message"></div>
    </div>

    <div id="forgotForm" class="form hidden">
      <label>Username</label>
      <input id="fpUsername" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p">
      <div id="fpQuestionArea" class="hidden">
        <label id="fpQuestionLabel">C√¢u h·ªèi</label>
        <input id="fpAnswer" type="text" placeholder="Tr·∫£ l·ªùi c√¢u h·ªèi b·∫£o m·∫≠t">
      </div>
      <div class="row">
        <button id="fpNext" class="primary">Ti·∫øp theo</button>
        <button id="fpCancel" class="link">H·ªßy</button>
      </div>
      <div id="fpMessage" class="message"></div>
    </div>

  </div>
</div>

<script src="login.js"></script>

</div>

<!-- FeelWell Page -->
<div id="feelwellPage" style="display:none">

  <div class="wrap">
    <header>
      <div>
        <h1>FeelWell ‚Äî Emotion Therapy (Science Fair Edition)</h1>
        <div class="small">
          Prototype: l·ªãch s·ª≠, ƒëi·ªÉm, bi·ªÉu ƒë·ªì, xu·∫•t CSV, √¢m thanh & animation nh·∫π.
        </div>
      </div>
      <div>
        <span class="small">ƒêi·ªÉm: </span><strong id="scoreDisplay">0</strong>
        <span style="margin-left:10px" class="badge" id="levelBadge">Novice</span>
      </div>
    </header>

    <div class="panel">
      <div class="left">
        <div class="card">
          <h3>1. Ch·ªçn nh√¢n v·∫≠t & phong c√°ch</h3>
          <div class="small">Avatar m·∫´u ho·∫∑c upload ·∫£nh, ch·ªçn m√†u, ƒë·∫∑t t√™n</div>
          <div class="avatar-list" id="avatarList"></div>
          <div class="color-row" id="colorRow"></div>
          <label class="small" style="display:block;margin-top:8px;cursor:pointer" id="uploadLabel">Upload ·∫£nh</label>
          <input type="file" id="imgUpload" accept="image/*" style="display:none">
          <div style="margin-top:10px">
            <input id="charName" placeholder="T√™n nh√¢n v·∫≠t (kh√¥ng b·∫Øt bu·ªôc)" class="task-input">
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" id="saveBtn">L∆∞u</button>
            <button class="btn-ghost" id="resetBtn">ƒê·∫∑t l·∫°i</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>2. Ch·ªçn tr·∫°ng th√°i c·∫£m x√∫c</h3>
          <div class="small">Ch·ªçn c·∫£m x√∫c ƒë·ªÉ nh·∫≠n nhi·ªám v·ª• ph√π h·ª£p</div>
          <div class="emotions" id="emotions"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>3. L·ªãch s·ª≠ & xu·∫•t d·ªØ li·ªáu</h3>
          <div class="small">L∆∞u m·ªçi l·∫ßn ho√†n th√†nh (localStorage). B·∫°n c√≥ th·ªÉ xu·∫•t CSV ƒë·ªÉ n·ªôp b√°o c√°o.</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn-primary" id="exportCsv">Xu·∫•t CSV</button>
            <button class="btn-ghost" id="clearHistory">X√≥a l·ªãch s·ª≠</button>
          </div>
          <div id="historyList" style="margin-top:12px;max-height:160px;overflow:auto"></div>
        </div>
      </div>

      <div class="right">
        <div class="card stage" id="stage">
          <div class="character" id="characterDisplay">üôÇ</div>
          <div class="item" id="itemDisplay"></div>
          <div id="taskArea" style="width:100%"></div>
          <div id="controls" style="width:100%"></div>
          <div id="feedback" class="notice" style="display:none"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>4. Th·ªëng k√™</h3>
          <div class="small">Bi·ªÉu ƒë·ªì t·∫ßn su·∫•t c·∫£m x√∫c (s·ªë l·∫ßn ho√†n th√†nh)</div>
          <div class="stats-grid">
            <div class="card chart-wrap"><canvas id="emotionChart"></canvas></div>
            <div class="card" style="padding:12px">
              <h4>Ti·∫øn tr√¨nh</h4>
              <div class="small">S·ªë l·∫ßn m·ªói c·∫£m x√∫c ƒë∆∞·ª£c ch·ªçn & ho√†n th√†nh</div>
              <div style="margin-top:12px" id="statCounts"></div>
            </div>
          </div>
        </div>

        <div class="footer">Ghi ch√∫: kh√¥ng thay th·∫ø tr·ªã li·ªáu chuy√™n nghi·ªáp. D√πng ƒë·ªÉ minh h·ªça d·ª± √°n khoa h·ªçc.</div>
      </div>
    </div>
  </div>

  <!-- Healthy AI Chatbox -->
  <div id="healthyAIWidget">
    <div id="healthyAIHeader">
      üí¨ Healthy AI
      <span id="healthyAIClose">√ó</span>
    </div>
    <div id="healthyAIBody">
      <div id="healthyAIChat"></div>
      <div id="healthyAIInputArea">
        <input type="text" id="healthyAIInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
        <button id="healthyAISend">G·ª≠i</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="feelwell.js"></script>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function initLoginPage(){
// Simple client-side auth using localStorage
// Users stored under key "feelwell_users" as an object: { username: { passwordHash, email, question, answerHash } }

function qs(id){return document.getElementById(id)}

// helpers: SHA-256 hashing (for demonstration, not secure server-side)
async function hashText(text){
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

function loadUsers(){ return JSON.parse(localStorage.getItem('feelwell_users')||'{}'); }
function saveUsers(u){ localStorage.setItem('feelwell_users', JSON.stringify(u)); }

// UI refs
const showLogin = qs('showLogin'), showRegister = qs('showRegister');
const loginForm = qs('loginForm'), registerForm = qs('registerForm'), forgotForm = qs('forgotForm');
const loginUsername = qs('loginUsername'), loginPassword = qs('loginPassword'), loginBtn = qs('loginBtn'), loginMessage = qs('loginMessage');
const regUsername = qs('regUsername'), regEmail = qs('regEmail'), regPassword = qs('regPassword'), regConfirm = qs('regConfirm'), regQuestion = qs('regQuestion'), regAnswer = qs('regAnswer'), registerBtn = qs('registerBtn'), regMessage = qs('regMessage');
const regToLogin = qs('regToLogin');
const forgotBtn = qs('forgotBtn'), fpUsername = qs('fpUsername'), fpNext = qs('fpNext'), fpCancel = qs('fpCancel'), fpQuestionArea = qs('fpQuestionArea'), fpQuestionLabel = qs('fpQuestionLabel'), fpAnswer = qs('fpAnswer'), fpMessage = qs('fpMessage');

// Tab handlers
showLogin.onclick = ()=>{ showLogin.classList.add('active'); showRegister.classList.remove('active'); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); forgotForm.classList.add('hidden'); clearMessages(); }
showRegister.onclick = ()=>{ showRegister.classList.add('active'); showLogin.classList.remove('active'); registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); forgotForm.classList.add('hidden'); clearMessages(); }
regToLogin.onclick = ()=> showLogin.click();

// Clear messages
function clearMessages(){ loginMessage.textContent=''; regMessage.textContent=''; fpMessage.textContent=''; }

// Registration
registerBtn.onclick = async ()=>{
  clearMessages();
  const username = regUsername.value.trim();
  const email = regEmail.value.trim();
  const pwd = regPassword.value;
  const confirm = regConfirm.value;
  const q = regQuestion.value;
  const ans = regAnswer.value.trim();

  if(!username || !email || !pwd || !confirm || !q || !ans){
    regMessage.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ tr∆∞·ªùng.';
    return;
  }
  if(pwd !== confirm){
    regMessage.textContent = 'M·∫≠t kh·∫©u v√† x√°c nh·∫≠n kh√¥ng kh·ªõp.';
    return;
  }
  // basic email format
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
    regMessage.textContent = 'Email kh√¥ng h·ª£p l·ªá.';
    return;
  }

  const users = loadUsers();
  if(users[username]){
    regMessage.textContent = 'T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ƒëƒÉng nh·∫≠p.';
    return;
  }

  const pwdHash = await hashText(pwd);
  const ansHash = await hashText(ans.toLowerCase());
  users[username] = { passwordHash: pwdHash, email: email, question: q, answerHash: ansHash, created: Date.now() };
  saveUsers(users);
  regMessage.classList.add('success');
  regMessage.textContent = 'ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.';
};

// Login
loginBtn.onclick = async ()=>{
  clearMessages();
  const username = loginUsername.value.trim();
  const pwd = loginPassword.value;
  if(!username || !pwd){ loginMessage.textContent = 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u.'; return; }
  const users = loadUsers();
  if(!users[username]){ loginMessage.textContent = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i, vui l√≤ng ƒëƒÉng k√Ω.'; return; }
  const pwdHash = await hashText(pwd);
  if(pwdHash !== users[username].passwordHash){ loginMessage.textContent = 'Sai m·∫≠t kh·∫©u. N·∫øu qu√™n, h√£y d√πng "Qu√™n m·∫≠t kh·∫©u".'; return; }
  // success
  localStorage.setItem('loggedInUser', username);
  // redirect to game
  window.location.href = 'feelwell.html';
};

// Forgot password flow
qs('forgotBtn').onclick = ()=>{ loginForm.classList.add('hidden'); registerForm.classList.add('hidden'); forgotForm.classList.remove('hidden'); clearMessages(); }
fpCancel.onclick = ()=>{ showLogin.click(); }

// Step: check username and show security question
fpNext.onclick = async ()=>{
  fpMessage.textContent = '';
  const username = fpUsername.value.trim();
  if(!username){ fpMessage.textContent = 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p.'; return; }
  const users = loadUsers();
  if(!users[username]){ fpMessage.textContent = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ƒëƒÉng k√Ω.'; return; }
  // show question
  fpQuestionArea.classList.remove('hidden');
  fpQuestionLabel.textContent = 'C√¢u h·ªèi: ' + (users[username].question === 'pet' ? 'T√™n th√∫ c∆∞ng ƒë·∫ßu ti√™n?' : users[username].question === 'school' ? 'T√™n tr∆∞·ªùng ti·ªÉu h·ªçc?' : 'T√™n th√†nh ph·ªë n∆°i b·∫°n sinh?');
  // change Next button to Verify / Reset
  fpNext.textContent = 'X√°c nh·∫≠n';
  // replace onclick to verify answer
  fpNext.onclick = async ()=>{
    const ans = fpAnswer.value.trim();
    if(!ans){ fpMessage.textContent = 'Vui l√≤ng nh·∫≠p c√¢u tr·∫£ l·ªùi.'; return; }
    const ansHash = await hashText(ans.toLowerCase());
    if(ansHash !== users[username].answerHash){ fpMessage.textContent = 'C√¢u tr·∫£ l·ªùi kh√¥ng ƒë√∫ng.'; return; }
    // allow reset password
    const newPwd = prompt('Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±):');
    if(!newPwd || newPwd.length < 6){ alert('M·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá.'); return; }
    const newHash = await hashText(newPwd);
    users[username].passwordHash = newHash;
    saveUsers(users);
    alert('ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng m·∫≠t kh·∫©u m·ªõi.');
    showLogin.click();
    // reset fp form
    fpUsername.value=''; fpAnswer.value=''; fpQuestionArea.classList.add('hidden'); fpNext.textContent='Ti·∫øp theo';
    fpNext.onclick = arguments.callee; // reset handler (not perfect but okay for prototype)
  };
};

}


function initFeelwellPage(){
// Redirect to login if not authenticated


// ----- Data -----
const AVATARS = ["üê±", "üê∂", "ü¶ä", "üêº", "üêµ", "ü¶Å", "üêª", "üê∏"];
const COLORS = [
  "#FFD6E0",
  "#E6F7FF",
  "#FFF4E6",
  "#EAFDE6",
  "#F0E6FF",
  "#FFE6F0",
  "#FFF1C9",
  "#DFF7E1",
];
const EMOTIONS = [
  // üåû Nh√≥m c·∫£m x√∫c T√çCH C·ª∞C
  {
    id: "happy",
    label: "Vui v·∫ª",
    emoji: "üòÑ",
    items: ["üåû", "üéà"],
    tasks: [
      { type: "timer", desc: "Nh·∫£y/v·∫≠n ƒë·ªông nh·∫π 30s", secs: 30, points: 10 },
      {
        type: "text",
        desc: "Vi·∫øt 3 ƒëi·ªÅu khi·∫øn b·∫°n vui",
        placeholder: "Ghi 3 ƒëi·ªÅu...",
        points: 8,
      },
    ],
  },
  {
    id: "excited",
    label: "H√†o h·ª©ng",
    emoji: "ü§©",
    items: ["üéâ", "üöÄ"],
    tasks: [
      {
        type: "share",
        desc: "Chia s·∫ª ni·ªÅm vui v·ªõi 1 ng∆∞·ªùi (g·ªçi/nh·∫Øn)",
        points: 8,
      },
      {
        type: "creative",
        desc: "V·∫Ω/ghi l·∫°i ƒëi·ªÅu khi·∫øn b·∫°n ph·∫•n kh·ªüi",
        points: 10,
      },
    ],
  },
  {
    id: "grateful",
    label: "Bi·∫øt ∆°n",
    emoji: "üôè",
    items: ["üåº", "üíñ"],
    tasks: [
      {
        type: "text",
        desc: "Vi·∫øt 3 ƒëi·ªÅu b·∫°n bi·∫øt ∆°n h√¥m nay",
        placeholder: "Ghi 3 ƒëi·ªÅu...",
        points: 10,
      },
      { type: "action", desc: "G·ª≠i l·ªùi c·∫£m ∆°n t·ªõi 1 ng∆∞·ªùi b·∫°n", points: 8 },
    ],
  },
  {
    id: "peaceful",
    label: "B√¨nh y√™n",
    emoji: "üåø",
    items: ["üïä", "‚òÅÔ∏è"],
    tasks: [
      {
        type: "timer",
        desc: "Ng·ªìi thi·ªÅn/h√≠t th·ªü s√¢u 2 ph√∫t",
        secs: 120,
        points: 10,
      },
      {
        type: "audio",
        desc: "Nghe ti·∫øng thi√™n nhi√™n 1 ph√∫t",
        secs: 60,
        points: 6,
      },
    ],
  },

  // üåß Nh√≥m c·∫£m x√∫c TI√äU C·ª∞C
  {
    id: "sad",
    label: "Bu·ªìn",
    emoji: "üò¢",
    items: ["üå∏", "‚òî"],
    tasks: [
      {
        type: "timer",
        desc: "T∆∞·ªõi hoa + th·ªü: h√≠t 4s, gi·ªØ 4s, th·ªü 6s (40s)",
        secs: 40,
        points: 12,
      },
      {
        type: "audio",
        desc: "Nghe 60s b√†i y√™u th√≠ch (t·ª± chu·∫©n b·ªã)",
        secs: 60,
        points: 8,
      },
    ],
  },
  {
    id: "angry",
    label: "Gi·∫≠n",
    emoji: "üò°",
    items: ["üî•", "ü•ä"],
    tasks: [
      {
        type: "active",
        desc: "T·∫≠p th·ªÉ d·ª•c m·∫°nh 1 ph√∫t (nh·∫£y d√¢y/nh·∫£y t·∫°i ch·ªó)",
        secs: 60,
        points: 14,
      },
      {
        type: "text",
        desc: "Vi·∫øt ra l√Ω do v√† gi·∫£i ph√°p, sau ƒë√≥ g·∫•p/hu·ª∑ b·ªè gi·∫•y",
        placeholder: "Vi·∫øt ra...",
        points: 10,
      },
    ],
  },
  {
    id: "anxious",
    label: "Lo l·∫Øng",
    emoji: "üò∞",
    items: ["üìù", "üßò‚Äç‚ôÄÔ∏è"],
    tasks: [
      {
        type: "text",
        desc: "Vi·∫øt 3 ƒëi·ªÅu bi·∫øt ∆°n",
        placeholder: "Ghi 3 ƒëi·ªÅu...",
        points: 10,
      },
      { type: "timer", desc: "H√≠t th·ªü ch·∫≠m 30s", secs: 30, points: 6 },
    ],
  },
  {
    id: "lonely",
    label: "C√¥ ƒë∆°n",
    emoji: "ü•∫",
    items: ["ü§ù", "üíå"],
    tasks: [
      { type: "call", desc: "G·ªçi/nh·∫Øn 1 ng∆∞·ªùi b·∫°n", points: 10 },
      {
        type: "text",
        desc: "Vi·∫øt th∆∞ cho ch√≠nh m√¨nh",
        placeholder: "G·ª≠i l·ªùi ƒë·ªông vi√™n...",
        points: 8,
      },
    ],
  },

  // üå§ Nh√≥m c·∫£m x√∫c TRUNG T√çNH
  {
    id: "tired",
    label: "M·ªát",
    emoji: "üò¥",
    items: ["üíß", "üõå"],
    tasks: [
      { type: "timer", desc: "Nh·∫Øm m·∫Øt ngh·ªâ 90s", secs: 90, points: 9 },
      { type: "action", desc: "U·ªëng 1 c·ªëc n∆∞·ªõc", points: 5 },
    ],
  },
  {
    id: "bored",
    label: "Ch√°n",
    emoji: "ü•±",
    items: ["üìö", "üé≤"],
    tasks: [
      {
        type: "creative",
        desc: "Th·ª≠ m·ªôt ho·∫°t ƒë·ªông m·ªõi trong 5 ph√∫t",
        points: 8,
      },
      {
        type: "text",
        desc: "Vi·∫øt 3 ƒëi·ªÅu b·∫°n c√≥ th·ªÉ l√†m h√¥m nay",
        placeholder: "Ghi √Ω t∆∞·ªüng...",
        points: 7,
      },
    ],
  },
  {
    id: "confused",
    label: "B·ªëi r·ªëi",
    emoji: "üòï",
    items: ["üß©", "üîç"],
    tasks: [
      {
        type: "text",
        desc: "Vi·∫øt ra 2 l·ª±a ch·ªçn v√† ∆∞u/nh∆∞·ª£c ƒëi·ªÉm",
        placeholder: "Ghi l·ª±a ch·ªçn...",
        points: 9,
      },
      {
        type: "timer",
        desc: "T·∫°m d·ª´ng v√† th∆∞ gi√£n 1 ph√∫t",
        secs: 60,
        points: 5,
      },
    ],
  },
  {
    id: "thoughtful",
    label: "Suy t∆∞",
    emoji: "ü§î",
    items: ["üìì", "üñã"],
    tasks: [
      {
        type: "text",
        desc: "Ghi l·∫°i suy nghƒ©/√Ω t∆∞·ªüng hi·ªán t·∫°i",
        placeholder: "Nh·∫≠p √Ω t∆∞·ªüng...",
        points: 9,
      },
      { type: "share", desc: "Chia s·∫ª √Ω t∆∞·ªüng v·ªõi 1 ng∆∞·ªùi b·∫°n", points: 8 },
    ],
  },
];

// ----- State -----
let state = {
  avatarIndex: 0,
  color: COLORS[0],
  name: "",
  emotion: null,
  history: [],
  score: 0,
};

// Load / Save
function loadState() {
  const s = localStorage.getItem("feelwell_full_v1");
  if (s) state = Object.assign(state, JSON.parse(s));
}
function saveState() {
  localStorage.setItem("feelwell_full_v1", JSON.stringify(state));
  renderAll();
}

// UI refs
const avatarList = document.getElementById("avatarList");
const colorRow = document.getElementById("colorRow");
const emotionsWrap = document.getElementById("emotions");
const characterDisplay = document.getElementById("characterDisplay");
const itemDisplay = document.getElementById("itemDisplay");
const taskArea = document.getElementById("taskArea");
const controls = document.getElementById("controls");
const feedback = document.getElementById("feedback");
const historyList = document.getElementById("historyList");
const scoreDisplay = document.getElementById("scoreDisplay");
const levelBadge = document.getElementById("levelBadge");
const statCounts = document.getElementById("statCounts");

// Renderers
function renderAvatars() {
  avatarList.innerHTML = "";
  AVATARS.forEach((a, i) => {
    const d = document.createElement("div");
    d.className = "avatar" + (state.avatarIndex === i ? " selected" : "");
    d.innerText = a;
    d.onclick = () => {
      state.avatarIndex = i;
      state.customImage = null;
      saveState();
    };
    avatarList.appendChild(d);
  });
}
function renderColors() {
  colorRow.innerHTML = "";
  COLORS.forEach((c) => {
    const s = document.createElement("div");
    s.className = "color-swatch" + (state.color === c ? " selected" : "");
    s.style.background = c;
    s.onclick = () => {
      state.color = c;
      saveState();
    };
    colorRow.appendChild(s);
  });
}
function renderEmotions() {
  emotionsWrap.innerHTML = "";
  EMOTIONS.forEach((e) => {
    const b = document.createElement("div");
    b.className = "emotion" + (state.emotion === e.id ? " selected" : "");
    b.innerHTML = `<div style="font-size:20px">${e.emoji}</div><div><strong>${e.label}</strong><div class="small">${e.tasks[0].desc}</div></div>`;
    b.onclick = () => {
      selectEmotion(e.id);
    };
    emotionsWrap.appendChild(b);
  });
}
function renderCharacter() {
  if (state.customImage) {
    characterDisplay.style.backgroundImage = `url(${state.customImage})`;
    characterDisplay.style.backgroundSize = "cover";
    characterDisplay.innerText = "";
  } else {
    characterDisplay.style.backgroundImage = "";
    characterDisplay.innerText = AVATARS[state.avatarIndex];
  }
  characterDisplay.style.backgroundColor = state.color;
}
function renderStage() {
  if (!state.emotion) {
    itemDisplay.innerHTML = "";
    taskArea.innerHTML = '<div class="small">Ch·ªçn c·∫£m x√∫c ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>';
    controls.innerHTML = "";
    feedback.style.display = "none";
    return;
  }
  const e = EMOTIONS.find((x) => x.id === state.emotion);
  itemDisplay.innerText = e.items[Math.floor(Math.random() * e.items.length)];
  const task = e.tasks[Math.floor(Math.random() * e.tasks.length)];
  taskArea.innerHTML = `<div><strong>Nhi·ªám v·ª•:</strong> ${task.desc}</div>`;
  renderControlsFor(task);
}
function renderHistory() {
  historyList.innerHTML = "";
  if (state.history.length === 0) {
    historyList.innerHTML =
      '<div class="small">Ch∆∞a c√≥ l·ªãch s·ª≠ ho√†n th√†nh.</div>';
    return;
  }
  state.history
    .slice()
    .reverse()
    .forEach((h) => {
      const d = document.createElement("div");
      d.style.padding = "8px";
      d.innerHTML = `<div><strong>${h.emotionLabel}</strong> ‚Äî ${new Date(
        h.ts
      ).toLocaleString()}</div><div class="small">${h.taskDesc} ‚Äî ${
        h.completed ? "Ho√†n th√†nh" : "B·ªè l·ª°"
      } (+${h.points}ƒë)</div>`;
      historyList.appendChild(d);
    });
}
function renderStats() {
  const counts = {};
  EMOTIONS.forEach((e) => (counts[e.id] = 0));
  state.history.forEach((h) => {
    if (h.completed) counts[h.emotion] = (counts[h.emotion] || 0) + 1;
  });
  statCounts.innerHTML = "";
  EMOTIONS.forEach((e) => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${e.label}:</strong> ${counts[e.id] || 0}`;
    statCounts.appendChild(div);
  });
  renderChart(counts);
}
function renderScoreAndLevel() {
  scoreDisplay.innerText = state.score;
  const lv =
    state.score >= 200
      ? "Master"
      : state.score >= 100
      ? "Advanced"
      : state.score >= 40
      ? "Intermediate"
      : "Novice";
  levelBadge.innerText = lv;
}

// Task controls
let countdownInterval = null;
let remaining = 0;
function renderControlsFor(task) {
  controls.innerHTML = "";
  feedback.style.display = "none";
  if (
    task.type === "timer" ||
    task.type === "audio" ||
    task.type === "active"
  ) {
    remaining = task.secs || 30;
    controls.innerHTML = `<div class="small">Th·ªùi gian: <span id="timerDisplay">${formatTime(
      remaining
    )}</span></div><div class="actions"><button class="btn-primary" id="startBtn">B·∫Øt ƒë·∫ßu</button><button class="btn-ghost" id="completeBtn" disabled>X√°c nh·∫≠n</button></div>`;
    document.getElementById("startBtn").onclick = () => startCountdown(task);
    document.getElementById("completeBtn").onclick = () => completeTask(task);
  } else if (
    task.type === "text" ||
    task.type === "creative" ||
    task.type === "action" ||
    task.type === "share" ||
    task.type === "call"
  ) {
    controls.innerHTML = `<textarea id="taskText" class="task-input" placeholder="${
      task.placeholder || "Ghi ·ªü ƒë√¢y..."
    }"></textarea><div class="actions"><button class="btn-primary" id="submitBtn">Ho√†n th√†nh</button></div>`;
    document.getElementById("submitBtn").onclick = () => completeTask(task);
  } else {
    controls.innerHTML = `<div class="small">Nh·∫•p Ho√†n th√†nh khi b·∫°n ƒë√£ l√†m nhi·ªám v·ª•.</div><div class="actions"><button class="btn-primary" id="quickComplete">Ho√†n th√†nh</button></div>`;
    document.getElementById("quickComplete").onclick = () => completeTask(task);
  }
  resetInactivityReminder();
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
}
function startCountdown(task) {
  const startBtn = document.getElementById("startBtn");
  const completeBtn = document.getElementById("completeBtn");
  startBtn.disabled = true;
  completeBtn.disabled = true;
  countdownInterval && clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    remaining--;
    document.getElementById("timerDisplay").innerText = formatTime(remaining);
    if (remaining <= 0) {
      clearInterval(countdownInterval);
      completeBtn.disabled = false;
      startBtn.disabled = false;
    }
  }, 1000);
}
function completeTask(task) {
  const ts = Date.now();
  const completed = true;
  const points = task.points || 5;
  const emotion = state.emotion;
  const emotionLabel = EMOTIONS.find((e) => e.id === emotion).label;
  const desc = task.desc;
  state.history.push({
    ts,
    emotion,
    emotionLabel,
    taskDesc: desc,
    completed,
    points,
  });
  state.score += points;
  saveState();
  feedback.style.display = "block";
  feedback.innerHTML = `<strong>Ho√†n th√†nh!</strong><div class="small">+${points} ƒëi·ªÉm ‚Äî ${task.desc}</div>`;
  characterDisplay.style.transform = "scale(1.06) rotate(-4deg)";
  itemDisplay.style.transform = "translateY(-6px) scale(1.08)";
  setTimeout(() => {
    characterDisplay.style.transform = "";
    itemDisplay.style.transform = "";
  }, 900);
  renderHistory();
  renderStats();
  renderScoreAndLevel();
  countdownInterval && clearInterval(countdownInterval);
}

// Emotion selection & inactivity
let reminderTimeout = null;
function selectEmotion(id) {
  state.emotion = id;
  saveState();
  renderStage();
}
function resetInactivityReminder() {
  clearTimeout(reminderTimeout);
  document.getElementById("feedback").style.display = "none";
  reminderTimeout = setTimeout(() => {
    document.getElementById("feedback").style.display = "block";
    document.getElementById("feedback").innerText = getComfortMessage();
  }, 30000);
}
function getComfortMessage() {
  const generalMsgs = [
    "M√¨nh v·∫´n ·ªü ƒë√¢y n·∫øu b·∫°n c·∫ßn nh√© üå∏",
    "Kh√¥ng sao n·∫øu ch∆∞a l√†m, b·∫Øt ƒë·∫ßu khi b·∫°n s·∫µn s√†ng üíõ",
    "B·∫°n ƒë√£ l√†m t·ªët khi nh·∫≠n bi·∫øt c·∫£m x√∫c c·ªßa m√¨nh ‚ù§Ô∏è",
    "C·∫£m x√∫c c·ªßa b·∫°n lu√¥n c√≥ gi√° tr·ªã üåø",
    "H√£y cho b·∫£n th√¢n m·ªôt ch√∫t kh√¥ng gian ƒë·ªÉ th·ªü üí®",
    "Nh·ªè b√© nh∆∞ng m·∫°nh m·∫Ω, gi·ªëng nh∆∞ b·∫°n üíé",
    "B·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c y√™u th∆∞∆°ng üíñ",
    "M·ªói ng√†y l√† m·ªôt c∆° h·ªôi m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu üåÖ",
    "H√£y l·∫Øng nghe c∆° th·ªÉ v√† tr√°i tim m√¨nh ü´Ä",
    "Kh√¥ng ai ho√†n h·∫£o, v√† ƒëi·ªÅu ƒë√≥ th·∫≠t tuy·ªát üí´",
  ];

  const emotionMsgs = {
    happy: [
      "Nghe c√≥ v·∫ª h√¥m nay b·∫°n r·∫•t vui! üéâ ƒêi·ªÅu g√¨ ƒë√£ khi·∫øn b·∫°n c∆∞·ªùi nhi·ªÅu th·∫ø?",
      "H√£y th·ª≠ chia s·∫ª ni·ªÅm vui n√†y v·ªõi ai ƒë√≥ nh√©, h·ªç s·∫Ω h·∫°nh ph√∫c l√¢y üíõ",
      "Gi·ªØ l·∫°i kho·∫£nh kh·∫Øc n√†y b·∫±ng m·ªôt b·ª©c ·∫£nh ho·∫∑c m·ªôt ghi ch√∫ ‚ú®",
      "K·ªÉ m√¨nh nghe, chuy·ªán g√¨ ƒë√£ l√†m b·∫°n m·ªâm c∆∞·ªùi t·ª´ s√°ng t·ªõi gi·ªù?",
      "B·∫°n c√≥ th·ªÉ bi·∫øn ni·ªÅm vui n√†y th√†nh ƒë·ªông l·ª±c l√†m ƒëi·ªÅu g√¨ ƒë√≥ m·ªõi m·∫ª!",
      "√Çm nh·∫°c v√† ni·ªÅm vui lu√¥n ƒëi c√πng nhau, b·∫≠t ngay b√†i b·∫°n th√≠ch nh·∫•t n√†o üé∂",
      "H√£y nh·ªõ c·∫£m gi√°c n√†y th·∫≠t k·ªπ, n√≥ l√† ngu·ªìn s·ª©c m·∫°nh c·ªßa b·∫°n",
      "Ni·ªÅm vui c·ªßa b·∫°n c√≥ th·ªÉ lan t·ªèa, h√£y th·ª≠ ch√∫c ai ƒë√≥ m·ªôt ng√†y t·ªët l√†nh",
      "M·ªôt ch√∫t nh·∫£y nh√≥t s·∫Ω l√†m ni·ªÅm vui th√™m tr·ªçn v·∫πn üï∫",
      "B·∫°n ƒë√£ t·ª± th∆∞·ªüng cho m√¨nh g√¨ ch∆∞a?",
      "ƒê√¢y l√† l√∫c ho√†n h·∫£o ƒë·ªÉ l√™n k·∫ø ho·∫°ch cho m·ªôt ƒëi·ªÅu th√∫ v·ªã",
      "Vi·∫øt m·ªôt l√° th∆∞ cho ch√≠nh m√¨nh trong t∆∞∆°ng lai khi b·∫°n c·∫ßn nh·ªõ l·∫°i kho·∫£nh kh·∫Øc n√†y",
      "Chia s·∫ª c√¢u chuy·ªán vui n√†y l√™n m·∫°ng x√£ h·ªôi ƒë·ªÉ lan t·ªèa nƒÉng l∆∞·ª£ng t√≠ch c·ª±c",
      "L√†m m·ªôt ƒëi·ªÅu t·ª≠ t·∫ø cho ng∆∞·ªùi kh√°c h√¥m nay nh√©",
      "Ni·ªÅm vui c·ªßa b·∫°n h√¥m nay s·∫Ω l√† k·ª∑ ni·ªám ƒë·∫πp sau n√†y",
      "ƒê·ª´ng qu√™n n√≥i l·ªùi c·∫£m ∆°n v·ªõi ai ƒë√£ khi·∫øn b·∫°n vui",
      "M·ªâm c∆∞·ªùi th·∫≠t t∆∞∆°i, ngay c·∫£ khi ch·ªâ m·ªôt m√¨nh üåº",
      "H√£y t·∫°o m·ªôt playlist 'Ng√†y Vui' ngay b√¢y gi·ªù",
      "B·∫°n ƒëang l√†m r·∫•t t·ªët trong vi·ªác nu√¥i d∆∞·ª°ng ni·ªÅm vui",
    ],
    sad: [
      "B·∫°n c√≥ mu·ªën k·ªÉ cho m√¨nh nghe ƒëi·ªÅu g√¨ ƒëang khi·∫øn b·∫°n bu·ªìn kh√¥ng? üíå",
      "H√£y th·ª≠ vi·∫øt ra 3 ƒëi·ªÅu khi·∫øn b·∫°n bi·∫øt ∆°n h√¥m nay nh√© üå±",
      "M·ªôt b·∫£n nh·∫°c nh·∫π c√≥ th·ªÉ gi√∫p t√¢m tr·∫°ng b·∫°n d·ªÖ ch·ªãu h∆°n üé∂",
      "Kh√≥c c≈©ng l√† m·ªôt c√°ch ƒë·ªÉ gi·∫£i t·ªèa, ƒë·ª´ng k√¨m n√©n n·∫øu b·∫°n c·∫ßn",
      "Ra ngo√†i h√≠t th·ªü kh√¥ng kh√≠ trong l√†nh s·∫Ω gi√∫p b·∫°n nh·∫π l√≤ng",
      "B·∫°n kh√¥ng c·∫ßn ph·∫£i m·∫°nh m·∫Ω m·ªçi l√∫c, cho ph√©p b·∫£n th√¢n y·∫øu ƒëu·ªëi c≈©ng ·ªïn",
      "H√£y √¥m m·ªôt chi·∫øc g·ªëi m·ªÅm ho·∫∑c th√∫ nh·ªìi b√¥ng ƒë·ªÉ c·∫£m th·∫•y an to√†n",
      "G·ªçi cho m·ªôt ng∆∞·ªùi b·∫°n m√† b·∫°n tin t∆∞·ªüng",
      "ƒê·ªçc m·ªôt v√†i trang s√°ch y√™u th√≠ch c√≥ th·ªÉ gi√∫p b·∫°n t·∫°m qu√™n ƒëi",
      "T·ª± n·∫•u m·ªôt m√≥n ƒÉn ·∫•m √°p v√† th∆∞·ªüng th·ª©c",
      "Nh·ªõ r·∫±ng m·ªçi c·∫£m x√∫c ƒë·ªÅu t·∫°m th·ªùi, k·ªÉ c·∫£ n·ªói bu·ªìn n√†y",
      "H√£y vi·∫øt nh·∫≠t k√Ω v·ªÅ c·∫£m gi√°c c·ªßa b·∫°n ngay l√∫c n√†y",
      "Nghe ti·∫øng m∆∞a ho·∫∑c √¢m thanh thi√™n nhi√™n ƒë·ªÉ xoa d·ªãu t√¢m tr·∫°ng",
      "H√¨nh dung v·ªÅ m·ªôt n∆°i khi·∫øn b·∫°n th·∫•y y√™n b√¨nh",
      "U·ªëng m·ªôt c·ªëc n∆∞·ªõc ·∫•m v√† th·ªü s√¢u",
      "Th·ª≠ thi·ªÅn 5 ph√∫t ƒë·ªÉ ƒë·∫ßu √≥c b·ªõt r·ªëi",
      "Nh√¨n l·∫°i nh·ªØng th√†nh t·ª±u b·∫°n ƒë√£ ƒë·∫°t ƒë∆∞·ª£c",
      "B·∫°n ƒë√£ v∆∞·ª£t qua nhi·ªÅu chuy·ªán kh√≥ khƒÉn tr∆∞·ªõc ƒë√¢y, l·∫ßn n√†y c≈©ng v·∫≠y",
      "G·ª≠i m·ªôt tin nh·∫Øn ƒë∆°n gi·∫£n: 'M√¨nh c·∫ßn ai ƒë√≥ l·∫Øng nghe'",
    ],
    angry: [
      "H√≠t s√¢u 3 l·∫ßn‚Ä¶ th·ªü ra th·∫≠t ch·∫≠m. B·∫°n c·∫£m th·∫•y th·∫ø n√†o r·ªìi? üåø",
      "Vi·∫øt ra l√Ω do khi·∫øn b·∫°n gi·∫≠n, sau ƒë√≥ vo tr√≤n t·ªù gi·∫•y v√† b·ªè ƒëi ‚úèÔ∏è",
      "Ho·∫°t ƒë·ªông th·ªÉ ch·∫•t m·∫°nh c√≥ th·ªÉ gi√∫p b·∫°n x·∫£ nƒÉng l∆∞·ª£ng ti√™u c·ª±c üí™",
      "ƒêi b·ªô nhanh ho·∫∑c ch·∫°y t·∫°i ch·ªó 1 ph√∫t",
      "B√≥p m·ªôt qu·∫£ b√≥ng stress ƒë·ªÉ gi·∫£i t·ªèa",
      "Nghe m·ªôt b√†i h√°t s√¥i ƒë·ªông ƒë·ªÉ chuy·ªÉn h∆∞·ªõng nƒÉng l∆∞·ª£ng",
      "T·ª± h·ªèi: ƒëi·ªÅu n√†y c√≥ c√≤n quan tr·ªçng sau 1 nƒÉm n·ªØa kh√¥ng?",
      "D·ª´ng l·∫°i 5 gi√¢y tr∆∞·ªõc khi n√≥i ho·∫∑c h√†nh ƒë·ªông",
      "R·ª≠a m·∫∑t b·∫±ng n∆∞·ªõc m√°t ƒë·ªÉ b√¨nh tƒ©nh h∆°n",
      "Tr√°nh ƒë∆∞a ra quy·∫øt ƒë·ªãnh khi ƒëang t·ª©c gi·∫≠n",
      "Vi·∫øt th∆∞ cho ng∆∞·ªùi khi·∫øn b·∫°n t·ª©c (kh√¥ng c·∫ßn g·ª≠i)",
      "Ng·ªìi xu·ªëng v√† t·∫≠p trung v√†o h∆°i th·ªü",
      "ƒê·∫øm ng∆∞·ª£c t·ª´ 50 th·∫≠t ch·∫≠m",
      "N√≥i ra c·∫£m x√∫c thay v√¨ gi·ªØ trong l√≤ng",
      "Tr√°nh caffeine ho·∫∑c ƒë∆∞·ªùng khi ƒëang gi·∫≠n",
      "Thay ƒë·ªïi m√¥i tr∆∞·ªùng xung quanh, b∆∞·ªõc sang ph√≤ng kh√°c",
      "V·∫Ω ngu·ªách ngo·∫°c ƒë·ªÉ x·∫£ b·ªõt c·∫£m x√∫c",
      "T√¨m ƒëi·ªÅu g√¨ ƒë√≥ khi·∫øn b·∫°n b·∫≠t c∆∞·ªùi",
      "Nh·ªõ r·∫±ng b·∫°n c√≥ quy·ªÅn ch·ªçn c√°ch ph·∫£n ·ª©ng",
    ],
    anxious: [
      "Th·ª≠ nh·∫Øm m·∫Øt v√† h√≠t v√†o 4s, gi·ªØ 4s, th·ªü ra 6s nh√© ü´Å",
      "Vi·∫øt ra ƒëi·ªÅu ƒëang khi·∫øn b·∫°n lo l·∫Øng ƒë·ªÉ d·ªÖ s·∫Øp x·∫øp l·∫°i suy nghƒ© üìÑ",
      "Nh·ªõ r·∫±ng c·∫£m gi√°c n√†y s·∫Ω kh√¥ng k√©o d√†i m√£i, b·∫°n s·∫Ω ·ªïn th√¥i üåà",
      "Gi·ªõi h·∫°n th·ªùi gian nghƒ© v·ªÅ v·∫•n ƒë·ªÅ ‚Äî v√≠ d·ª• 10 ph√∫t",
      "T·∫≠p trung v√†o m·ªôt v·∫≠t tr∆∞·ªõc m·∫∑t v√† mi√™u t·∫£ n√≥",
      "Nghe √¢m thanh thi√™n nhi√™n ho·∫∑c nh·∫°c nh·∫π",
      "Tr√°nh ƒë·ªçc tin ti√™u c·ª±c trong l√∫c lo l·∫Øng",
      "T·∫Øm n∆∞·ªõc ·∫•m ƒë·ªÉ th∆∞ gi√£n",
      "Nh·∫Øc b·∫£n th√¢n: 'M√¨nh ƒë√£ v∆∞·ª£t qua nhi·ªÅu l·∫ßn tr∆∞·ªõc ƒë√¢y'",
      "H·ªèi: ƒëi·ªÅu t·ªá nh·∫•t c√≥ th·ªÉ x·∫£y ra l√† g√¨? V√† m√¨nh s·∫Ω l√†m g√¨ n·∫øu n√≥ x·∫£y ra?",
      "H√≠t th·ªü s√¢u v√† t∆∞·ªüng t∆∞·ª£ng n∆°i an to√†n",
      "T·∫≠p th·∫£ l·ªèng t·ª´ng nh√≥m c∆° tr√™n c∆° th·ªÉ",
      "ƒêi d·∫°o 5 ph√∫t ngo√†i tr·ªùi",
      "H·∫°n ch·∫ø caffeine",
      "T·∫≠p trung v√†o vi·ªác m√¨nh c√≥ th·ªÉ ki·ªÉm so√°t",
      "Vi·∫øt ra 3 ƒëi·ªÅu t·ªët ƒëang t·ªìn t·∫°i",
      "Chia s·∫ª v·ªõi m·ªôt ng∆∞·ªùi b·∫°n ƒë√°ng tin",
      "L√†m m·ªôt vi·ªác nh·ªè ƒë·ªÉ l·∫•y l·∫°i c·∫£m gi√°c ki·ªÉm so√°t",
      "U·ªëng m·ªôt ng·ª•m n∆∞·ªõc ch·∫≠m r√£i v√† t·∫≠p trung v√†o c·∫£m gi√°c",
    ],
    tired: [
      "H√£y cho c∆° th·ªÉ ngh·ªâ m·ªôt ch√∫t, ch·ªâ c·∫ßn 2 ph√∫t nh·∫Øm m·∫Øt th√¥i c≈©ng ƒë∆∞·ª£c üò¥",
      "U·ªëng m·ªôt c·ªëc n∆∞·ªõc m√°t ƒë·ªÉ t·ªânh t√°o h∆°n nh√© üíß",
      "N·∫øu c√≥ th·ªÉ, h√£y ƒë·ª©ng d·∫≠y v√† v∆∞∆°n vai th·∫≠t d√†i ‚ú®",
      "Nghe m·ªôt b√†i nh·∫°c nh·∫π ƒë·ªÉ th∆∞ gi√£n",
      "Nh·∫Øm m·∫Øt v√† t∆∞·ªüng t∆∞·ª£ng m√¨nh ƒëang ·ªü n∆°i y√™n tƒ©nh",
      "ƒÇn nh·∫π m·ªôt th·ª© l√†nh m·∫°nh",
      "T·∫Øt m√†n h√¨nh ƒëi·ªán tho·∫°i 5 ph√∫t",
      "Ng·ªìi th·∫≥ng l∆∞ng v√† h√≠t s√¢u",
      "Ra ngo√†i h√≠t th·ªü kh√¥ng kh√≠",
      "Gi·∫£m √°nh s√°ng xung quanh",
      "Ng·ªß tr∆∞a 15 ph√∫t",
      "Massage nh·∫π vai v√† c·ªï",
      "T·∫Øm nhanh ƒë·ªÉ l√†m m·ªõi c∆° th·ªÉ",
      "ƒêi b·ªô ch·∫≠m",
      "Tr√°nh ƒë·ªì u·ªëng c√≥ c·ªìn",
      "Vi·∫øt ra 3 ƒëi·ªÅu khi·∫øn b·∫°n m·ªát v√† t√¨m gi·∫£i ph√°p ƒë∆°n gi·∫£n",
      "L·∫Øng nghe nh·ªãp tim c·ªßa m√¨nh",
      "ƒê·∫∑t b√°o th·ª©c ngh·ªâ gi·∫£i lao",
      "Th·ª≠ yoga ho·∫∑c thi·ªÅn ng·∫Øn",
    ],
    excited: [
      "Wow! ƒêi·ªÅu g√¨ ƒë√£ khi·∫øn b·∫°n h√†o h·ª©ng v·∫≠y? üöÄ",
      "H√£y ghi l·∫°i √Ω t∆∞·ªüng ho·∫∑c c·∫£m x√∫c n√†y, bi·∫øt ƒë√¢u n√≥ s·∫Ω r·∫•t qu√Ω gi√° sau n√†y üìî",
      "Chia s·∫ª ni·ªÅm h·ª©ng kh·ªüi v·ªõi b·∫°n b√® ho·∫∑c ƒë·ªìng nghi·ªáp nh√© üåü",
      "D√πng nƒÉng l∆∞·ª£ng n√†y ƒë·ªÉ ho√†n th√†nh m·ªôt m·ª•c ti√™u",
      "T·∫°o m·ªôt playlist nh·∫°c cho t√¢m tr·∫°ng n√†y",
      "L√™n k·∫ø ho·∫°ch cho d·ª± √°n b·∫°n m∆° ∆∞·ªõc",
      "Ch·ª•p ·∫£nh kho·∫£nh kh·∫Øc hi·ªán t·∫°i",
      "G·ª≠i tin nh·∫Øn t√≠ch c·ª±c cho ai ƒë√≥",
      "V·∫Ω ho·∫∑c s√°ng t·∫°o g√¨ ƒë√≥ ngay",
      "Th·ª≠ m·ªôt ho·∫°t ƒë·ªông m·ªõi",
      "L·∫≠p danh s√°ch 5 ƒëi·ªÅu b·∫°n mu·ªën l√†m",
      "Nghƒ© v·ªÅ c√°ch lan t·ªèa nƒÉng l∆∞·ª£ng n√†y",
      "Vi·∫øt blog ho·∫∑c status chia s·∫ª",
      "Mua m·ªôt m√≥n qu√† nh·ªè cho b·∫£n th√¢n",
      "T·∫≠p th·ªÉ d·ª•c ƒë·ªÉ nh√¢n ƒë√¥i nƒÉng l∆∞·ª£ng",
      "Ch∆°i m·ªôt tr√≤ ch∆°i y√™u th√≠ch",
      "N·∫•u m√≥n ƒÉn b·∫°n th√≠ch",
      "Nghe podcast truy·ªÅn c·∫£m h·ª©ng",
      "Ghi √¢m c·∫£m x√∫c c·ªßa b·∫°n",
    ],
    lonely: [
      "B·∫°n ƒë√£ th·ª≠ nh·∫Øn tin cho m·ªôt ng∆∞·ªùi b·∫°n c≈© ch∆∞a? üì±",
      "H√£y ra ngo√†i ƒëi d·∫°o, ƒë√¥i khi ch·ªâ c·∫ßn thay ƒë·ªïi m√¥i tr∆∞·ªùng l√† t√¢m tr·∫°ng s·∫Ω kh√° h∆°n üå≥",
      "Nh·ªõ r·∫±ng b·∫°n kh√¥ng th·ª±c s·ª± m·ªôt m√¨nh üíñ",
      "Tham gia m·ªôt nh√≥m c·ªông ƒë·ªìng tr·ª±c tuy·∫øn",
      "G·ªçi video cho ng∆∞·ªùi th√¢n",
      "ƒê·ªçc s√°ch ho·∫∑c xem phim ƒë·ªÉ b·∫ßu b·∫°n v·ªõi nh√¢n v·∫≠t",
      "Nu√¥i m·ªôt c√¢y c·∫£nh nh·ªè",
      "Vi·∫øt th∆∞ tay cho m·ªôt ai ƒë√≥",
      "ƒêƒÉng k√Ω l·ªõp h·ªçc m·ªõi",
      "Th·ª≠ n·∫•u ƒÉn ho·∫∑c l√†m b√°nh",
      "T√¨nh nguy·ªán ·ªü n∆°i g·∫ßn b·∫°n",
      "Nghe podcast tr√≤ chuy·ªán",
      "Tham gia di·ªÖn ƒë√†n s·ªü th√≠ch",
      "M·ªü nh·∫°c v√† h√°t theo",
      "G·∫∑p g·ª° ai ƒë√≥ t·∫°i qu√°n c√† ph√™",
      "ƒêi b·∫£o t√†ng ho·∫∑c c√¥ng vi√™n",
      "Vi·∫øt nh·∫≠t k√Ω v·ªÅ c·∫£m x√∫c c√¥ ƒë∆°n",
      "Ch∆°i v·ªõi th√∫ c∆∞ng",
      "L·∫≠p k·∫ø ho·∫°ch cho cu·ªëi tu·∫ßn",
    ],
  };

  if (state.emotion && emotionMsgs[state.emotion]) {
    const list = emotionMsgs[state.emotion];
    return list[Math.floor(Math.random() * list.length)];
  }

  return generalMsgs[Math.floor(Math.random() * generalMsgs.length)];
}

// CSV export
function exportCSV() {
  if (state.history.length === 0) {
    alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.");
    return;
  }
  const header = [
    "timestamp",
    "emotion",
    "emotionLabel",
    "taskDesc",
    "completed",
    "points",
  ];
  const rows = state.history.map((h) =>
    [
      new Date(h.ts).toISOString(),
      h.emotion,
      h.emotionLabel,
      `"${h.taskDesc.replace(/"/g, '""')}"`,
      h.completed,
      h.points,
    ].join(",")
  );
  const csv = [header.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "feelwell_history.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Helpers UI
document.getElementById("exportCsv").onclick = exportCSV;
document.getElementById("clearHistory").onclick = () => {
  if (confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠?")) {
    state.history = [];
    saveState();
  }
};
document.getElementById("saveBtn").onclick = () => {
  state.name = document.getElementById("charName").value || "";
  saveState();
  alert("ƒê√£ l∆∞u c·∫•u h√¨nh.");
};
document.getElementById("resetBtn").onclick = () => {
  if (confirm("ƒê·∫∑t l·∫°i to√†n b·ªô?")) {
    localStorage.removeItem("feelwell_full_v1");
    location.reload();
  }
};
document.getElementById("uploadLabel").onclick = () =>
  document.getElementById("imgUpload").click();
document.getElementById("imgUpload").addEventListener("change", (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const rd = new FileReader();
  rd.onload = (e) => {
    state.customImage = e.target.result;
    saveState();
  };
  rd.readAsDataURL(f);
});

// Chart
let chartInstance = null;
function renderChart(counts) {
  const ctx = document.getElementById("emotionChart").getContext("2d");
  const labels = EMOTIONS.map((e) => e.label);
  const data = EMOTIONS.map((e) => counts[e.id] || 0);
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "S·ªë l·∫ßn ho√†n th√†nh",
          data,
          backgroundColor: EMOTIONS.map(
            (_, i) =>
              [
                "#60a5fa",
                "#fca5a5",
                "#fbbf24",
                "#34d399",
                "#f472b6",
                "#c084fc",
                "#93c5fd",
              ][i % 7]
          ),
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, precision: 0 } },
    },
  });
}

// Render all
function renderAll() {
  renderAvatars();
  renderColors();
  renderEmotions();
  renderCharacter();
  renderStage();
  renderHistory();
  renderStats();
  renderScoreAndLevel();
}

// Boot
loadState();
renderAll();
resetInactivityReminder();
// ---- Healthy AI Chatbox ----
const aiHeader = document.getElementById("healthyAIHeader");
const aiBody = document.getElementById("healthyAIBody");
const aiChat = document.getElementById("healthyAIChat");
const aiInput = document.getElementById("healthyAIInput");
const aiSend = document.getElementById("healthyAISend");

let aiHistory = JSON.parse(localStorage.getItem("healthy_ai_history") || "[]");

// Render history
function renderAIHistory() {
  aiChat.innerHTML = "";
  aiHistory.forEach((msg) => {
    const div = document.createElement("div");
    div.className = `healthyAIMessage ${msg.sender}`;
    div.textContent = msg.text;
    aiChat.appendChild(div);
  });
  aiChat.scrollTop = aiChat.scrollHeight;
}

// Toggle chat
aiHeader.addEventListener("click", () => {
  aiBody.style.display = aiBody.style.display === "flex" ? "none" : "flex";
});

// Send message
function sendAIMessage() {
  const text = aiInput.value.trim();
  if (!text) return;

  // Add user message
  aiHistory.push({ sender: "user", text });
  aiInput.value = "";
  renderAIHistory();
  saveAIHistory();

  // Fake AI response (B·∫°n c√≥ th·ªÉ k·∫øt n·ªëi API AI th·∫≠t ·ªü ƒë√¢y)
  setTimeout(() => {
    const reply = getAIReply(text);
    aiHistory.push({ sender: "ai", text: reply });
    renderAIHistory();
    saveAIHistory();
  }, 700);
}

function getAIReply(userText) {
  // Simple AI reply logic (thay b·∫±ng API call n·∫øu mu·ªën)
  if (userText.includes("bu·ªìn"))
    return "M√¨nh hi·ªÉu, h√£y th·ª≠ h√≠t th·ªü s√¢u v√† nghƒ© ƒë·∫øn ƒëi·ªÅu khi·∫øn b·∫°n h·∫°nh ph√∫c nh√© üå∏";
  if (userText.includes("m·ªát")) return "B·∫°n n√™n ngh·ªâ ng∆°i v√† u·ªëng n∆∞·ªõc nh√© üíß";
  return "M√¨nh ·ªü ƒë√¢y ƒë·ªÉ l·∫Øng nghe b·∫°n ‚ù§Ô∏è";
}

function saveAIHistory() {
  localStorage.setItem("healthy_ai_history", JSON.stringify(aiHistory));
}

aiSend.addEventListener("click", sendAIMessage);
aiInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendAIMessage();
});

// Kh·ªüi ƒë·ªông
renderAIHistory();

}


// Page toggle logic
(function(){
    if (localStorage.getItem("loggedInUser")) {
        document.getElementById("feelwellPage").style.display = "block";
        initFeelwellPage();
    } else {
        document.getElementById("loginPage").style.display = "block";
        initLoginPage();
        // Patch login success to switch view
        const origLoginBtn = document.getElementById("loginBtn");
        if(origLoginBtn) {
            origLoginBtn.onclick = async function(){
                const username = document.getElementById('loginUsername').value.trim();
                const pwd = document.getElementById('loginPassword').value;
                const users = JSON.parse(localStorage.getItem('feelwell_users')||'{}');
                if(!users[username]){ document.getElementById('loginMessage').textContent = 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.'; return; }
                const enc = new TextEncoder();
                const data = enc.encode(pwd);
                const hashBuf = await crypto.subtle.digest('SHA-256', data);
                const arr = Array.from(new Uint8Array(hashBuf));
                const pwdHash = arr.map(b=>b.toString(16).padStart(2,'0')).join('');
                if(pwdHash !== users[username].passwordHash){ document.getElementById('loginMessage').textContent = 'Sai m·∫≠t kh·∫©u.'; return; }
                localStorage.setItem('loggedInUser', username);
                document.getElementById("loginPage").style.display = "none";
                document.getElementById("feelwellPage").style.display = "block";
                initFeelwellPage();
            }
        }
    }
})();
</script>
</body>
</html>
